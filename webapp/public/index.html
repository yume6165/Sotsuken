<!DOCTYPE html>
<html>
  <head>
	<link rel="shortcut icon" href='/images/login_bg.jpg' type="image/x-icon">

    <link href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.css" rel="stylesheet">
  
    <link rel="stylesheet" type="text/css" href="./css/style.css">
    
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js"></script>
    
	<script src='./js/jquery.min.js'></script>
	
	<link href="https://fonts.googleapis.com/css?family=Cherry+Swash:700 rel="stylesheet">
	
    <!--chart.jsを利用-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.1.4/Chart.min.js"></script>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
	
  </head>
  <body>
    <div class="title_space">
	<a href="./">
    　THEMIS -THeoretical Estimation of Meaning of InSult-　　
	</a>　　 
	<a href="./login">
	<button type="button" class="btn_w" name="login" >
    <font size="1">Login</font>
    </button>
	</a>
	<a href="./logout">
	<button type="button" class="btn_w" name="logout" >
    <font size="1">Logout</font>
    </button>
	</a>
    </div>
     
	
	
	<div id="wrap">
    <div class="inline_box">
	
	<div class="name_box"><p>Note</p></div>
	<div class="memo_area">
	<form method="post" action="./note">
		<textarea class="textbox_title" id="note_title" name="note_title" rows="1" cols="15" placeholder="Title"></textarea>
		<textarea class="textbox" id="note" name="note" rows="5" cols="30" placeholder="You can write your note here and save."></textarea>
		<br>
		<div class="right_side">
			<input class="btn_b" type="submit" value="Save">
		</div>
	</form>
	</div>
	
	<div class="name_box"><p>Context</p></div>
		
	<div id="select_context">
		<form name="select_context">
			<select name="select_context">
				<option value="0">All</option>
				<option value="1">Incision</option>
				<option value="2">Contusion</option>
			</select>
		</form>
		
		<div class="right_side">
			<button type="button" name="select_context" onclick="app_context()">
				apply
			</button>
		</div>
	</div>
	
	<div class="name_box"><p >Similarity</p></div>
    <!--棒グラフ表示-->
    <canvas id="stage" style="position:relative;　height:40vh; width:80vw"></canvas>
    </div>
    
    <!--ネットワーク表示-->
    <div class="inline_box">
    <div id="network"></div>
    <div id="mater">
      　　　<!--わざと空白入れてる-->
    </div>
	
	<!--情報をフィルタリングする-->
	<div id="graph_filter">
		Display rate of Edges
		<!--ドラッグ中に数値が変化してほしいのでonclicはあえて使わない-->
		<input type="range" id="range" min="0" max="100" step="10" value="100">
 <span id="value">100</span>％
	</div>
	
    </div>
    
    <!--第３セクション-->
    <div class="inline_box">
	
	<!--ユーザのログイン情報などを通知-->
	<div class="name_box"><p>System message</p></div>
		<div id="user_info">
		ここにログイン情報が表示されます
		</div>
		<div id="sys_info">
		ここにシステムメッセージが入ります
		</div>
		<!--read onlyの情報を表示,更新ボタンとかあるといいかも-->
	
	<!--案件データの読み込み-->
	<div class="name_box"><p id="wound_name">Read Data</p></div>
	<div id="main_data">
	Main Data : 
	<button type="button" class="anken_js-modal-open" name="select_anken" onclick="search_file_a()">
    <font size="1">Reference</font>
    </button>
    <div class="anken_modal anken_js-modal">
		
        <div class="anken_modal__bg anken_js-modal-close"></div>
		<div class="anken_sub_modal">
        <div class="anken_modal__content">
		<p>Researching apploaded datas…</p>
        </div><!--modal__inner-->
		<form action="./anken_up" id="anken_up" method="POST">
		<input type="file" name="anken">
		<input type="submit" name="up_anken" value="Upload">
		</form>
		<input id="anken" type="hidden" value="hoge">
		<button type="button" class="anken_js-modal-close">Back</button>
		</div>
    </div><!--modal-->
	
	</div>
	<div id="data_base">
	Data Base : 
	<button type="button" class="db_js-modal-open" name="select_db" onclick="search_file_d()">
    <font size="1">Reference</font>
    </button>
    <div class="db_modal db_js-modal">
		
        <div class="db_modal__bg db_js-modal-close"></div>
		<div class="db_sub_modal">
        <div class="db_modal__content">
		<p>Researching apploaded datas…</p>
        </div><!--modal__inner-->
		<form id="db_up">
		<input type="file" name="db">
		<input type="submit" name="up_db" onclick="upload_db()" value="Upload">
		</form>
		<input id="db" type="hidden" value="db">
		<button type="button" class="db_js-modal-close">Back</button>
		</div>
    </div><!--modal-->
	
	</div>
	<!--創傷データの表示-->
    <div id="wound_feild">
      <div id="wound_img_name">
        <div class="name_box"><p id="wound_name">Wound Name</p></div>
        <image id="wound_ori_img" title="wound" src="https://cdn.glitch.com/a71c879d-dcf2-41d9-accb-3bac81f35ea0%2Fnone_icon.svg?v=1576918386493" height="100"></image>
        <image id="wound_edge_img" title="wound_edge" src="https://cdn.glitch.com/a71c879d-dcf2-41d9-accb-3bac81f35ea0%2Fnone_icon.svg?v=1576918386493" height="100"></image>

      </div>
      
      <div class="inline_box">
      <div id="wound_figure">
        <form name="wound_figure">
        <input type="image" id="close_icon" title="close" src="https://cdn.glitch.com/a71c879d-dcf2-41d9-accb-3bac81f35ea0%2Fclose_icon.svg?v=1576909771220" height="35" width="35">
        <input type="image" id="open_icon" title="open" src="https://cdn.glitch.com/a71c879d-dcf2-41d9-accb-3bac81f35ea0%2Fopen_icon.svg?v=1576909771233" height="35" width="35">
        <input type="image" id="end_sharp_icon" title="end_sharp" src="https://cdn.glitch.com/a71c879d-dcf2-41d9-accb-3bac81f35ea0%2Fend_sharp_icon.svg?v=1576909771247" height="35" width="35">
        <input type="image" id="end_irregular_icon" title="end_irregular" src="https://cdn.glitch.com/a71c879d-dcf2-41d9-accb-3bac81f35ea0%2Fend_irregular_icon.svg?v=1576909771602" height="35" width="35">
        <br>
        <input type="image" id="end_thick_icon" title="end_thick" src="https://cdn.glitch.com/a71c879d-dcf2-41d9-accb-3bac81f35ea0%2Fend_thick_icon.svg?v=1576909771586" height="35" width="35">
        <input type="image" id="edge_straight_icon" title="edge_straight" src="https://cdn.glitch.com/a71c879d-dcf2-41d9-accb-3bac81f35ea0%2Fedge_straight_icon.svg?v=1576909771594" height="35" width="35">
        <input type="image" id="edge_irregular_icon" title="edge_irregular" src="https://cdn.glitch.com/a71c879d-dcf2-41d9-accb-3bac81f35ea0%2Fedge_irregular_icon.svg?v=1576909771240" height="35" width="35">
        <input type="image" id="oval_icon" title="oval" src="https://cdn.glitch.com/a71c879d-dcf2-41d9-accb-3bac81f35ea0%2Foval_icon.svg?v=1576917665497" height="35" width="35">
          <!--<input type="image" id="contusion_bruise_icon" title="contusion_bruise" src="https://cdn.glitch.com/a71c879d-dcf2-41d9-accb-3bac81f35ea0%2Fcontusion_bruise.svg?v=1576909771874" height="35" width="35">-->
        </form>
      </div>
      </div>
      
      <div class="inline_box">
      <div id="wound_color">
        <image id="wound_color_map" title="wound_color_map" src="https://cdn.glitch.com/a71c879d-dcf2-41d9-accb-3bac81f35ea0%2Fnone_icon.svg?v=1576918386493" height="160" width="160"></image>
      </div>
      </div>
      
    </div>
    </div>
    
    <div id="timeline"></div>
	</div>
    
<script type="text/javascript">

//メインページが呼び出されるとすぐに呼ばれる関数
window.onload = function(){
	//cookieを読み込んで”System　Messageに表示”
	var cookie = document.cookie;//ここにcookieの情報が入る
	var user = {themis_user_id:'guest', themis_session_id:'none'};//ユーザ情報の初期化
	var tips = {themis_user_id:'guest', themis_session_id:'none', sys_info:''};//cookieの情報を入れる箱
	//cookieのデータは辞書型で保存する
	//他のサイトがつけたCookieと競合しないようにidenticalな名前にした方が良さそう
	if(cookie != null){
		var keys = cookie.split('; ');
		//cookieをfor文で回してuser_idとsessionを回収
		//順番が前後する可能性があるので，あえて辞書型で収容したほうが良さそう
		for(var i=0; i < keys.length; i++){
			var tmp = keys[i].split('=');
			tips[tmp[0]] = tmp[1];
			//user[tmp[0]] = tmp[1];//ユーザの情報を入れた
			//console.log(user);
		}	
	}
	
	
	if(tips['themis_user_id'] != ''　|| tips['themis_user_id'] != 'guest'){
		//もし、ログインしていたらuser名とセッションidを記録
		user['themis_user_id'] = tips['themis_user_id'];
		user['themis_session_id'] = tips['themis_session_id'];
	}
	
	
	//ゲストの名前を表示
	var user_info = document.getElementById('user_info');
	user.innerHTML = 'Hello! ';
	user_info.innerHTML += user['themis_user_id'];
	user_info.innerHTML += '.';
	
	//システムからのメッセ―ジがあれば表示
	var sys_info = document.getElementById('sys_info');
	sys_info.innerHTML = '';
	if(tips['themis_sys_info'] == null || tips['themis_sys_info'] == ''){
		sys_info.innerHTML = 'There is no message.';
	}else{
		sys_info.innerHTML = tips['themis_sys_info'];
	}
	
	
}


//Timelineに関する記述
var container = document.getElementById("timeline");

// Create a DataSet (allows two way data-binding)
var items = new vis.DataSet([
  { id: 1, content: "now", start: "2014-04-20" }

]);

// Configuration for the Timeline
var options = {};

// Create a Timeline
var timeline = new vis.Timeline(container, items, options);


      
function define_edge_color(w, max, min)
      {
        def = max - min;
        w  = Math.round(w * 256 / def);
        m  = Math.round(min * 256 / def);
        w -= m;
        console.log(w);
        //入ってきたエッジの重みからいエッジの色を決定
        if(w < 16){
          var r = 0;
          var g = 0;
          var b = w;
        }
        else if(w >= 16 && w < 120){
          var r = 0;
          var g = Math.round((w - 16) * 104 / 256);
          var b = Math.round(256 + (w - 16) * -104 / 256);
          
        }
        else if(w >= 120 && w < 136)
        {
          var r = 0;
          var g = w;
          var b = 0;
        }
        else if(w >= 136 && w < 240){
          var r = Math.round((w - 136) * 104 / 256);
          var g = Math.round(256 + (w - 136) * -104 / 256);
          var b = 0;
          
        }
        else if(w >= 240 && w < 256)
        {
          var r = w;
          var g = 0;
          var b = 0;
        }  
        
       // console.log(r);
        
        var rgb = [];
        rgb.push(r);
        rgb.push(g);
        rgb.push(b);
        c = RGB2Hex(rgb);
        
        return c;
      } 
      
function define_edge_color2(w, max, min)
      {
        def = max - min;
        w  = Math.round(w * 255 / def);
        m  = Math.round(min * 255 / def);
        w -= m;
       // console.log(w);
        //入ってきたエッジの重みからいエッジの色を決定
        var r = Math.floor(w * 180 / 256 + 75);
        var g = Math.round(w * 215 / 256);
        var b = Math.round(130 - w * 130 / 256);
        
       // console.log(r + ' , ' + g + ' , '+ b);
        
        var rgb = [];
        rgb.push(r);
        rgb.push(g);
        rgb.push(b);
        c = RGB2Hex(rgb);
        
        return c;
      }  

function RGB2Hex(rgb)//３次元配列で入力
      {
        color_list = []
        r1 = String(Math.floor(rgb[0] / 16));
        color_list.push(r1);
        r2 = String(Math.floor(rgb[0] % 16));
        color_list.push(r2);
        g1 = String(Math.floor(rgb[1] / 16));
        color_list.push(g1);
        g2 = String(Math.floor(rgb[1] % 16));
        color_list.push(g2);
        b1 = String(Math.floor(rgb[2] / 16));
        color_list.push(b1);
        b2 = String(Math.floor(rgb[2] % 16));
        color_list.push(b2);
        var color = '#';
        
        for(var i=0; i < color_list.length; i++)
        {
          if(color_list[i] >= 10)
          {
              switch(color_list[i])
              { 
                case '10': color_list[i] ="A";
                  break;
                case '11': color_list[i] ="B";
                  break;
                case '12': color_list[i] ="C";
                  break;
                case '13': color_list[i] ="D";
                  break;
                case '14': color_list[i] ="E";
                  break;
                case '15': color_list[i] ="F";
                  break;
                
              }
          }
          color += color_list[i];
        }
        //console.log(color);
        return color;
        
      }

function csvToArray(path) {
        var csvData = new Array();
        var data = new XMLHttpRequest();        
        data.open("GET", path, false);
        data.send(null);
        var LF = String.fromCharCode(10);
        var lines = data.responseText.split(LF);
        for (var i = 0; i < lines.length;++i) {
                var cells = lines[i].split(",");
                if( cells.length != 1 ) {
                        csvData.push(cells);
                }
        }
        return csvData;
}

  
      
      
      //データのインプット
      //forで回したいけど方法がわからない
      //類似度を入力
      distance = [];
      distances = [];
      distances.push(csvToArray("./result/output_file/anken_dist/0_no_context.csv"));
	  //console.log(distances)
      //distances.push(distance);
      distances.push(csvToArray("https://cdn.glitch.com/a71c879d-dcf2-41d9-accb-3bac81f35ea0%2F1_incision_context.csv?v=1580197280693"));
      //distances.push(distance);
      distances.push(csvToArray("https://cdn.glitch.com/a71c879d-dcf2-41d9-accb-3bac81f35ea0%2F2_contusion_context.csv?v=1580197280719"));
      //distances.push(distance);
      //console.log(distances)
      
      
      //画像データを読み込み
      img_info = [];
      img_info.push(csvToArray("https://cdn.glitch.com/a71c879d-dcf2-41d9-accb-3bac81f35ea0%2Fimg_infos.csv?v=1581089085901"));
      
	  //余分な配列を削除する
      //console.log(img_info[0]);
      //for(var i=0; i < Math.floor((img_info[0].length) / 2)+1; i++)
      //{ 
      //    img_info[0].splice(1 + i, 1);
      //}
      //console.log(img_info);
      
      
      //画像のベクトルを読み込み
      img_vec = [];
      img_vec.push(csvToArray("https://cdn.glitch.com/a71c879d-dcf2-41d9-accb-3bac81f35ea0%2Fimg_vec.csv?v=1581088250439"));
      console.log(img_vec);
      
      //console.log(distances);
      c_num = distances.length;
      i_num = distances[0].length;
      
      
      
      
      
      //各文脈に関してノードを生成（どの文脈でもノードは変わらないからいらない説）
      context_nodes_list =[];
      for(var k=0; k < c_num; k++)
      {
        node_list = [];
        for(var i = 0; i < i_num; i++)
        {
          var a = {id: i, label: String(i), color:"#ffff00"};
          node_list.push(a);
        }
        var nodes = new vis.DataSet(node_list);
        context_nodes_list.push(nodes);
      }
  //console.log(context_node_list);
      
      //重みの計算（文字列から数字に変換）
      w_list = [];//全体まとめる
      for(var k=0; k < c_num; k++)
      {
        w_context_list=[];//コンテクストごと
        for(var i = 0; i < i_num; i++)
        {
          for(var j = 0; j < i_num ; j++)
          {
            //console.log(distances[0][k][i][j])
            if(parseFloat(distances[k][i][j]) == 0)
            {
              w_context_list.push(0);
              continue;
            }
            w_context_list.push(1/(parseFloat(distances[k][i][j])));
           //console.log(w_list);
          }
        }
        w_list.push(w_context_list);
       
      }
      
      //console.log(w_list);
      var max_list = [];
      var min_list = [];
      for(var i=0; i < c_num; i++)
      {

          max_list.push(Math.max.apply(null, w_list[i]));
          var min_tmp = w_list[i].slice();//コピー
          min_tmp = min_tmp.sort();
          min_list.push(min_tmp[i_num]);//2番目に大きい数
       // w_mid = (w_max + w_min) / 2;
        
      }
     // console.log(max_list);
     // console.log(min_list);
      //最終的な最大値
      w_max = Math.max.apply(null,max_list);
      w_min = Math.min.apply(null,min_list);
      //console.log(w_max);
      //console.log(w_min);
      
function sort_data(w, index, context)
      {
        var a = Math.sqrt(w[context].length);//データの数
        var tmp = w[context];
       // console.log(w);
        tmp = tmp.slice(index * a, index * a + a);
        tmp = tmp.sort(
                        function(a,b) {
                        // 戻り値が正（b-aの差が正）のとき、aをbの前に並べ替え
                        // 戻り値が負（b-aの差が負）のとき、aをbの後ろ並べ替え
                        return b - a;
                      }
                      );

        //console.log(w[0][context]);
        var result_labels = [];
        for(var i=0; i < a - 1; i++)
        {
          var num = w_list[context].indexOf(tmp[i]);
          var name = "Wound_" + String(num);
          result_labels.push(name);
        }
        //console.log(result_labels);
        var max = Math.max.apply(null, tmp);
        var result =[];
        result.push(result_labels);
        result.push(tmp);
        result.push(max);
        //console.log(tmp);
        return result;

      }
      
      
      //ここから棒グラフ描画のための準備
      var labels = [];
      var data = [];
      var sort_data = sort_data(w_list, 0, 0);//初期値は0
      //console.log(sort_data);
      var stage = document.getElementById('stage').getContext("2d");
      var myBar = new Chart(stage,{
        type: 'horizontalBar',
        data:{
          labels:sort_data[0],
          datasets:[{
            data:sort_data[1],
            backgroundColor:['#FF4444', '#4444FF', '#44BB44', '#FFFF44', '#FF44FF']
          }]
        },
         options: {                             //◆オプション
            responsive: true,                  //グラフ自動設定
            legend: {                          //凡例設定
                display: false                 //表示設定
           },
            title: {                           //タイトル設定
                display: false,                 //表示設定
                fontSize: 18,                  //フォントサイズ
                text: 'タイトル'                //ラベル
            },
            scales: {                          //軸設定
                yAxes: [{                      //y軸設定
                    display: true,             //表示設定
                    barPercentage: 0.4,           //棒グラフ幅
                    categoryPercentage: 0.4,
                    scaleLabel: {              //軸ラベル設定
                       display: false,          //表示設定
                       labelString: '創傷',  //ラベル
                       fontSize: 11               //フォントサイズ
                    },
                    ticks: {                      //最大値最小値設定
                        min: 0,                   //最小値
                        max: sort_data[2],                  //最大値
                        fontSize: 11,             //フォントサイズ
                        stepSize: 5               //軸間隔
                    },
                }],
                xAxes: [{                         //x軸設定
                    display: true,                //表示設定
                    barPercentage: 0.2,           //棒グラフ幅
                    categoryPercentage: 0.2,      //棒グラフ幅
                    scaleLabel: {                 //軸ラベル設定
                       display: true,             //表示設定
                       labelString: '類似度',  //ラベル
                       fontSize: 11               //フォントサイズ
                    },
                    ticks: {
                        fontSize: 11             //フォントサイズ
                    },
                }],
            },
            layout: {                             //レイアウト
                padding: {                          //余白設定
                    left: 50,
                    right: 100,
                    top: 0,
                    bottom: 0
                }
            }
        }
    });
        
      
      
     // for(var i=0; i < c_num; i++)
     // {
        
     // }
      
      
      //ここからグラフ描画のための準備
      context_edges_list =[];
	  context_edges_list_b = [];//こちらは単純にリスト構造
      for(var k=0; k < c_num; k++)
      {
        edge_list = [];
		var count = 0
        for(var i = 0; i < i_num; i++)
        {
          for(var j = i+1; j < i_num ; j++)
          {
            w = Number(distances[k][i][j]);
            //console.log(distances[0][k][i][j]);
            var w_tmp = 1 / w;
            w = 3 / w;
            
            //console.log(w_max);
            
            //色を決定する
            //console.log(w_max);
            var c = define_edge_color2(w_tmp, w_max, w_min);
            
          //  var r = Math.round(Math.abs(w_max - w_tmp) / w_max * 255);
          //  var g = Math.round(Math.abs(w_mid - w_tmp) / w_max * 255);
          //  var b = Math.round(Math.abs(w_min - w_tmp) / w_max * 255);
          //  var rgb = [];
          //  rgb.push(r);
          //  rgb.push(g);
          //  rgb.push(b);
          //  c = RGB2Hex(rgb);
            
            var a = {id:count, from: i, to: j, width:w*2, color:{highlight:c , color:c}};
            edge_list.push(a);
			count += 1;
          }
        }
        var edges = new vis.DataSet(edge_list);
        context_edges_list.push(edges);
		context_edges_list_b.push(edge_list);
      }
    
  
  //卒論のためにcomputerの例を入れる（ノード）
  //var t_node_list = [];
  //var com = {id: 0, label: "computer", color:"#ff0000"};
  //var soft = {id: 1, label: "software", color:"#ffff00"};
  //var hard = {id: 2, label: "hardware", color:"#ffff00"};
  //t_node_list.push(com);
  //t_node_list.push(soft);
  //t_node_list.push(hard);
  
  //卒論のためにcomputerの例を入れる（エッジ）
  //var t_edge_list = [];
  //var color = define_edge_color2(13, 14, 10);
  //var a = {from: 0, to: 1, width:9, color:{highlight:color , color:color}};
  //var color = define_edge_color2(13, 14, 10);
  //var b = {from: 0, to: 2, width:9, color:{highlight:color , color:color}};
  //var color = define_edge_color2(11, 14, 10);
  //var c = {from: 1, to: 2, width:7, color:{highlight:color , color:color}};
  //t_edge_list.push(a);
  //t_edge_list.push(b);
  //t_edge_list.push(c);
  
  var data ={
    nodes:node_list,
    edges:edge_list
  }
      
      var container = document.getElementById('network');
      //c_numでコンテクストの数がわかっているので、そこから切り替える
      var data = {
        nodes: context_nodes_list[0],
        edges: context_edges_list[0]
      };
      
      var options = {
        
        nodes: {
          shape: "dot",
          size: 10,
        borderWidth: 1,
      }, 
        
         edges: {
           smooth: true,
           //shadow: true,
         }
        
        
      };
      var network = new vis.Network(container, data, options);
      
      
      //ノードがクリックされたときの処理
      network.on("click", function(params) {
        if (params.nodes.length == 1) {
          var nodeId = params.nodes[0];
          var node = nodes.get(nodeId);
          //var option_select = {};
          nodes.update([{id: 1, color: {background: '#ffffff'}}]); 
          //network.setOptions(option_select);
          console.log(node.label + 'がクリックされました');
          
          
          //nodeIDから情報を習得して創傷の情報を表示
          //傷画像の表示
          var wound_ori_img = document.getElementById("wound_ori_img");
          var wound_edge_img = document.getElementById("wound_edge_img");
          var wound_color_map = document.getElementById("wound_color_map");
          wound_ori_img.src = img_info[0][nodeId][0];
          wound_edge_img.src = img_info[0][nodeId][1];
          wound_color_map.src = img_info[0][nodeId][2];
          console.log(wound_ori_img.src);
          //画像の名前適用
          var wound_name = document.getElementById("wound_name");
          //wound_name.innerHTML = "Wound_"+ String(nodeId);
          
          //iconの透過度を変更
          //console.log(img_vec[0][nodeId]);
          var open_icon = document.getElementById("open_icon");
          var close_icon = document.getElementById("close_icon");
          var end_sharp_icon = document.getElementById("end_sharp_icon");
          var end_irregular_icon = document.getElementById("end_irregular_icon");
          var end_thick_icon = document.getElementById("end_thick_icon");
          var edge_straight_icon = document.getElementById("edge_straight_icon");
          var oval_icon = document.getElementById("oval_icon");
          //var contusion_bruise_icon = document.getElementById("contusion_bruise_icon");
          
          //透過度の初期化（全て透過度0.3へ）
          open_icon.style.opacity = 0.3;
          close_icon.style.opacity = 0.3;
          end_sharp_icon.style.opacity = 0.3;
          end_irregular_icon.style.opacity = 0.3;
          end_thick_icon.style.opacity = 0.3;
          edge_straight_icon.style.opacity = 0.3;
          oval_icon.style.opacity = 0.3;
          edge_irregular_icon.style.opacity = 0.3;
          
          if(img_vec[0][nodeId][0] == "1")
            end_sharp_icon.style.opacity = 1.0;
          
          if(img_vec[0][nodeId][1] == "1")
            end_thick_icon.style.opacity = 1.0;
              
          if(img_vec[0][nodeId][2] == "1")
            edge_irregular_icon.style.opacity = 1.0;
              
          if(img_vec[0][nodeId][3] == "1")
            edge_straight_icon.style.opacity = 1.0;
              
          if(img_vec[0][nodeId][4] == "1")
            oval_icon.style.opacity = 1.0;
              
          if(img_vec[0][nodeId][5] == "1")
            open_icon.style.opacity = 1.0;
              
          if(img_vec[0][nodeId][6] == "1")
            close_icon.style.opacity = 1.0;
         
         //end_irregularはまだ実装してないので保留
         // if(img_vec[0][nodeId][7] == "1")
         //   end_irregular_icon.style.opacity = 1.0;
              
           
        }
        
        var context = document.select_context.select_context;
        var num = context.selectedIndex;
        //console.log(context);
        var num2 = Number(context.options[num].value);
        //console.log(num2);
        
        //棒グラフの更新
        var a = Math.sqrt(w_list[num2].length);//データの数
        var tmp = w_list[num2];
        //console.log(tmp);
        tmp1 = tmp.slice(nodeId * a, nodeId * a + a);
        //console.log(tmp1);
        tmp = tmp1.sort(
                        function(a,b) {
                        // 戻り値が正（b-aの差が正）のとき、aをbの前に並べ替え
                        // 戻り値が負（b-aの差が負）のとき、aをbの後ろ並べ替え
                        return b - a;
                      }
                      );
        //console.log(tmp);
        //console.log(w[0][context]);
        var result_labels = [];
        for(var i=0; i < a ; i++)
        {
          if(i == nodeId)
            continue;
          //console.log(tmp1.indexOf(tmp[i]));
          var num3 = (tmp1.indexOf(tmp[i]));
          var name = "Wound_" + String(num3);
          result_labels.push(name);
        }
        //console.log(result_labels);
        var max = Math.max.apply(null, tmp);
        var result =[];
        result.push(result_labels);
        result.push(tmp);
        result.push(max);
        //console.log(tmp);
        
        var labels = [];
        var data = [];
        var sort = result;//初期値は0
        //console.log(sort);
        var stage = document.getElementById('stage').getContext("2d");
        myBar.destroy();
        myBar = new Chart(stage,{
          type: 'horizontalBar',
          data:{
            labels:sort[0],
            datasets:[{
              data:sort[1],
              backgroundColor:['#FF4444', '#4444FF', '#44BB44', '#FFFF44', '#FF44FF']
            }]
          },
           options: {                             //◆オプション
              responsive: true,                  //グラフ自動設定
              legend: {                          //凡例設定
                  display: false                 //表示設定
             },
              title: {                           //タイトル設定
                  display: false,                 //表示設定
                  fontSize: 18,                  //フォントサイズ
                  text: 'タイトル'                //ラベル
              },
              scales: {                          //軸設定
                  yAxes: [{                      //y軸設定
                      display: true,             //表示設定
                      barPercentage: 0.4,           //棒グラフ幅
                      categoryPercentage: 0.4,
                      scaleLabel: {              //軸ラベル設定
                         display: false,          //表示設定
                         labelString: '創傷',  //ラベル
                         fontSize: 11               //フォントサイズ
                      },
                      ticks: {                      //最大値最小値設定
                          min: 0,                   //最小値
                          max: sort_data[2],                  //最大値
                          fontSize: 11,             //フォントサイズ
                          stepSize: 5               //軸間隔
                      },
                  }],
                  xAxes: [{                         //x軸設定
                      display: true,                //表示設定
                      barPercentage: 0.2,           //棒グラフ幅
                      categoryPercentage: 0.2,      //棒グラフ幅
                      scaleLabel: {                 //軸ラベル設定
                         display: true,             //表示設定
                         labelString: '類似度',  //ラベル
                         fontSize: 11               //フォントサイズ
                      },
                      ticks: {
                          fontSize: 11             //フォントサイズ
                      },
                  }],
              },
              layout: {                             //レイアウト
                  padding: {                          //余白設定
                      left: 50,
                      right: 100,
                      top: 0,
                      bottom: 0
                  }
              }
          }
      });
        
      });
	  
	  
	  
	//ネットワークの"Display rate of edges"のスライダーバーの設定
	//ノードの場合はエッジも切らないといけない
	var elem = document.getElementById('range');
	var target = document.getElementById('value');
	var rangeValue = function (elem, target) {
		return function(evt){
		var flag = 0;//エッジを足すのか引くのかを示すフラグ
		if(Number(target.innerHTML) < Number(elem.value))
		{
			flag = 1;
		}

		target.innerHTML = elem.value;
		//elem.valueは文字列
		//ここにエッジの再描画を記述
		//console.log(edges)
		//エッジの本数を取得
		edge_length = Number(edges.length);
		
		//何本表示するかを計算
		view_length = Math.floor(Number(elem.value) * edge_length / 100);
		hide_length = edge_length - view_length;
		
		//elem.valueに値する本数だけ残して後は隠す
		var context = document.select_context.select_context;
        var num = context.selectedIndex;
        var num2 = Number(context.options[num].value);
        
		//利用しているエッジは下のエッジ
		//console.log(context_edges_list_b[num2]);
		//console.log(context_edges_list[num2]);
		//重みの相関グラフ（読み込んだやつ）から相関が小さいエッジのidを探して非表示にする
		
		//エッジの小さい順にidを並べて非表示にするものを探し出す
		//ここのソートはエッジを作成段階で行ってもいいかも
		for(var i=0; i < edge_length; i++)
		{
			context_edges_list_b[num2].sort(function(a, b){
				if(a.width > b.width){
					return 1;
				}else{
					return -1;
				}
			})
		}
		//重みが小さい順に並び替えられている
		//console.log(context_edges_list_b[num2]);		
		
		
		//表示する割合が減ったとき：類似度の低いエッジから消していく
		if(flag == 0)
		{
			//console.log("消すのは"+hide_length+"本です");
			for(var i=0; i < hide_length; i++)
			{
				var num = Number(context_edges_list_b[num2][i].id);
				//console.log(num+"を隠します");
				network.body.data.edges.update({id: num, hidden: true});
				network.fit();
			}
		}else//表示する割合が増えたとき：類似度の高いエッジから表示していく
		{
			//console.log(edge_length+"本表示するよ！！");
			for(var i=0; i < view_length; i++)
			{
				var num = Number(context_edges_list_b[num2][edge_length - i - 1].id);
				//console.log(num+"を表示します");
				network.body.data.edges.update({id: num, hidden: false});
				network.fit();
			}
		}
	  }
	}
	elem.addEventListener('input', rangeValue(elem, target));

	
    function app_context()//文脈を読み込んで表示
      {
        //console.log("app_contextが押されました");
        var context = document.select_context.select_context;
        var num = context.selectedIndex;
        //console.log(context);
        var num2 = Number(context.options[num].value);
        //console.log(num2);
        var d = {
        nodes: context_nodes_list[0],
        edges: context_edges_list[num2]
      };
        network = new vis.Network(container, d, options);
		
         network.on("click", function(params) {
        if (params.nodes.length == 1) {
          var nodeId = params.nodes[0];
          var node = nodes.get(nodeId);
          //var option_select = {};
          nodes.update([{id: 1, color: {background: '#ffffff'}}]); 
          //network.setOptions(option_select);
          console.log(node.label + 'がクリックされました');
          
          
          //nodeIDから情報を習得して創傷の情報を表示
          //傷画像の表示
          var wound_ori_img = document.getElementById("wound_ori_img");
          var wound_edge_img = document.getElementById("wound_edge_img");
          var wound_color_map = document.getElementById("wound_color_map");
          wound_ori_img.src = img_info[0][nodeId][0];
          wound_edge_img.src = img_info[0][nodeId][1];
          wound_color_map.src = img_info[0][nodeId][2];
          console.log(wound_ori_img.src);
          //画像の名前適用
          var wound_name = document.getElementById("wound_name");
          //wound_name.innerHTML = "Wound_"+ String(nodeId);
          
          //iconの透過度を変更
          //console.log(img_vec[0][nodeId]);
          var open_icon = document.getElementById("open_icon");
          var close_icon = document.getElementById("close_icon");
          var end_sharp_icon = document.getElementById("end_sharp_icon");
          var end_irregular_icon = document.getElementById("end_irregular_icon");
          var end_thick_icon = document.getElementById("end_thick_icon");
          var edge_straight_icon = document.getElementById("edge_straight_icon");
          var oval_icon = document.getElementById("oval_icon");
          //var contusion_bruise_icon = document.getElementById("contusion_bruise_icon");
          
          //透過度の初期化（全て透過度0.3へ）
          open_icon.style.opacity = 0.3;
          close_icon.style.opacity = 0.3;
          end_sharp_icon.style.opacity = 0.3;
          end_irregular_icon.style.opacity = 0.3;
          end_thick_icon.style.opacity = 0.3;
          edge_straight_icon.style.opacity = 0.3;
          oval_icon.style.opacity = 0.3;
          edge_irregular_icon.style.opacity = 0.3;
          
          if(img_vec[0][nodeId][0] == "1")
            end_sharp_icon.style.opacity = 1.0;
          
          if(img_vec[0][nodeId][1] == "1")
            end_thick_icon.style.opacity = 1.0;
              
          if(img_vec[0][nodeId][2] == "1")
            edge_irregular_icon.style.opacity = 1.0;
              
          if(img_vec[0][nodeId][3] == "1")
            edge_straight_icon.style.opacity = 1.0;
              
          if(img_vec[0][nodeId][4] == "1")
            oval_icon.style.opacity = 1.0;
              
          if(img_vec[0][nodeId][5] == "1")
            open_icon.style.opacity = 1.0;
              
          if(img_vec[0][nodeId][6] == "1")
            close_icon.style.opacity = 1.0;
         
         //end_irregularはまだ実装してないので保留
         // if(img_vec[0][nodeId][7] == "1")
         //   end_irregular_icon.style.opacity = 1.0;
              
           
        }
        
        var context = document.select_context.select_context;
        var num = context.selectedIndex;
        //console.log(context);
        var num2 = Number(context.options[num].value);
        //console.log(num2);
		
        //棒グラフの更新
        var a = Math.sqrt(w_list[num2].length);//データの数
        var tmp = w_list[num2];
       // console.log(w);
        tmp = tmp.slice(0 * a, 0 * a + a);
        tmp = tmp.sort(
                        function(a,b) {
                        // 戻り値が正（b-aの差が正）のとき、aをbの前に並べ替え
                        // 戻り値が負（b-aの差が負）のとき、aをbの後ろ並べ替え
                        return b - a;
                      }
                      );

        //console.log(w[0][context]);
        var result_labels = [];
        for(var i=0; i < a - 1; i++)
        {
          var num3 = w_list[num2].indexOf(tmp[i]);
          var name = "Wound_" + String(num3);
          result_labels.push(name);
        }
        //console.log(result_labels);
        var max = Math.max.apply(null, tmp);
        var result =[];
        result.push(result_labels);
        result.push(tmp);
        result.push(max);
        //console.log(tmp);
        
        var labels = [];
        var data = [];
        var sort = result;//初期値は0
        //console.log(sort);
        var stage = document.getElementById('stage').getContext("2d");
        myBar.destroy();
        myBar = new Chart(stage,{
          type: 'horizontalBar',
          data:{
            labels:sort[0],
            datasets:[{
              data:sort[1],
              backgroundColor:['#FF4444', '#4444FF', '#44BB44', '#FFFF44', '#FF44FF']
            }]
          },
           options: {                             //◆オプション
              responsive: true,                  //グラフ自動設定
              legend: {                          //凡例設定
                  display: false                 //表示設定
             },
              title: {                           //タイトル設定
                  display: false,                 //表示設定
                  fontSize: 18,                  //フォントサイズ
                  text: 'タイトル'                //ラベル
              },
              scales: {                          //軸設定
                  yAxes: [{                      //y軸設定
                      display: true,             //表示設定
                      barPercentage: 0.4,           //棒グラフ幅
                      categoryPercentage: 0.4,
                      scaleLabel: {              //軸ラベル設定
                         display: false,          //表示設定
                         labelString: '創傷',  //ラベル
                         fontSize: 11               //フォントサイズ
                      },
                      ticks: {                      //最大値最小値設定
                          min: 0,                   //最小値
                          max: sort_data[2],                  //最大値
                          fontSize: 11,             //フォントサイズ
                          stepSize: 5               //軸間隔
                      },
                  }],
                  xAxes: [{                         //x軸設定
                      display: true,                //表示設定
                      barPercentage: 0.2,           //棒グラフ幅
                      categoryPercentage: 0.2,      //棒グラフ幅
                      scaleLabel: {                 //軸ラベル設定
                         display: true,             //表示設定
                         labelString: '類似度',  //ラベル
                         fontSize: 11               //フォントサイズ
                      },
                      ticks: {
                          fontSize: 11             //フォントサイズ
                      },
                  }],
              },
              layout: {                             //レイアウト
                  padding: {                          //余白設定
                      left: 50,
                      right: 100,
                      top: 0,
                      bottom: 0
                  }
              }
          }
      });
	  });
        }  
    
    //案件データの読み込み（ローカルファイルのパスを得る）
	function loadFile_changeHandler(e){
    var files = e.target.files;
    var fileData = "";
    for(var i = 0; i < files.length; i++){
        var fileVal = files[i];
        fileData +=
            'ファイル名：' + escape(fileVal.name) + '<br>' +
            'ファイルサイズ：' + fileVal.size + ' バイト<br>' +
            'MIMEタイプ：' + fileVal.type + '<br>' +
            '最終更新日時：' + fileVal.lastModifiedDate + '<hr>';
        }
	
	}
 
	function $(id) {
		return document.querySelector(id);
	}
	
	function search_file_a(){//readhtml.js(nodejs)に接続したい
		//console.log("Hello");
		var result = "";
		
		jQuery(function($){
		$('#info').innerHTML = fileData;
		});
		var url = './anken_search';
		var request = new XMLHttpRequest();
		request.open('GET', url);
		request.onreadystatechange = function(){
			if(request.readyState != 4){
				//リクエスト中
			}else if(request.status != 200){
				//失敗
			}else{
				//取得成功:案件情報の取得
				result = request.responseText;
				result = result.replace('[','');
				result = result.replace(']','');
				result = result.split(',');
				var f_names = [];
				for(var i = 0; i < result.length; i++){
					var f_name = result[i].split('\\');
					f_name[f_name.length - 1] = f_name[f_name.length - 1].replace("'", "");
					f_names.push(f_name[f_name.length - 1]);
					//console.log(f_name[f_name.length - 1]);
				}
				
				jQuery(function($){
					//<button type="button" class="js-modal-close">×</button>
					//案件データの検索結果を表示するhtmlの作成
					var html ='<div>';
					html += 'Select data which you want to take.</br>';
					html += '<select name="example">';
					for(var i = 0; i < result.length; i++){
						html += '<option value="'+ String(i) + '">' + f_names[i] + '</option>'
					}
					html += '</select></br>';
					//html += '';
					html +='</div>';
					$('.anken_modal__content').html(html);
				});
				//console.log(result);
			}
		};
		request.send(null);
		
		
	}
	
	jQuery(function($){
			
			$('.anken_js-modal-open').on('click',function(){
			$('.anken_js-modal').fadeIn();
			return false;
			});
			$('.anken_js-modal-close').on('click',function(){
				$('.anken_js-modal').fadeOut();
				return false;
			});
		});
		
	jQuery(function($){
			
			$('.db_js-modal-open').on('click',function(){
			$('.db_js-modal').fadeIn();
			return false;
			});
			$('.db_js-modal-close').on('click',function(){
				$('.db_js-modal').fadeOut();
				return false;
			});
		});
	
	
	function search_file_d(){//readhtml.js(nodejs)に接続したい
		//console.log("Hello");
		var result = "";
		
		jQuery(function($){
		$('#info').innerHTML = fileData;
		});
		var url = './db_search';
		var request = new XMLHttpRequest();
		request.open('GET', url);
		request.onreadystatechange = function(){
			if(request.readyState != 4){
				//リクエスト中
			}else if(request.status != 200){
				//失敗
			}else{
				//取得成功:案件情報の取得
				//データセットになるので，フォルダの選択やアップロードをしなくてはいけない（後日）
				
				result = request.responseText;
				result = result.replace('[','');
				result = result.replace(']','');
				result = result.split(',');
				var f_names = [];
				for(var i = 0; i < result.length; i++){
					var f_name = result[i].split('\\');
					f_name[f_name.length - 1] = f_name[f_name.length - 1].replace("'", "");
					f_names.push(f_name[f_name.length - 1]);
					//console.log(f_name[f_name.length - 1]);
				}
				console.log(f_name[0]);
				jQuery(function($){
					//<button type="button" class="js-modal-close">×</button>
					//案件データの検索結果を表示するhtmlの作成
					
					var html ='<div>';
					html += 'Select data sets which you want to take.</br>';
					html += '<select name="example">';
					for(var i = 0; i < result.length; i++){
						html += '<option value="'+ String(i) + '">' + f_names[i] + '</option>'
					}
					html += '</select></br>';
					//html += '';
					html +='</div>';
					$('.db_modal__content').html(html);
				});
				//console.log(result);
			}
		};
		request.send(null);
		
		
	}
	
	//案件のアップロード
	function upload_anken(){
		//formデータの取得
		jQuery(function($){
		$(document).on('change','input[name="anken"]',function(){
		var fd = new FormData();
		if ($("input[name='anken']").val()!== '') {
			fd.append( "file", $("input[name='anken']").prop("files")[0] );
		}
		fd.append("dir",$("#anken").val());
		var postData = {
			type : "POST",
			dataType : "text",
			data : fd,
			processData : false,
			contentType : false
		};
		$.ajax(
			"upload.php", postData
		).done(function( text ){
			console.log(text);
		});
		});
		});
	}
	
	//データベースのアップロード
	function upload_db(){
		console.log("ここで画像をアップします！");
	}
	

	
    </script>
    

    
  </body>
  </html>